# Specification Document

## Data Models

### 1. Alert (User Subscription)
Represents a user's subscription to specific keywords or items.
*   **UserID** `string`: The Discord User ID.
*   **Keywords** `string`: The raw string of keywords/requirements typed by the user.
*   **BooleanQuery** `string`: The optimized search string generated by the AI (e.g., `"RTX 3080" AND NOT "broken"`).

### 2. PostRecord (Processed Reddit Post)
Maintains state on posts we have already evaluated to prevent duplicate alerting and allow for state updates.
*   **RedditID** `string`: The unique ID of the post (e.g., `t3_1abcdef`).
*   **ServerMappings** `map[string]string`: Maps Discord Server IDs (`GuildID`) to the specific Discord Message IDs (`MsgID`) sent to that server. Used for retroactively striking out sold listings.

### 3. ServerRouting (Guild Configuration)
Defines where the bot should send alerts for a specific Discord server.
*   **GuildID** `string`: The unique Discord Server ID.
*   **ChannelID** `string`: The Discord Channel ID where deal embeds should be posted.

## Internal APIs

### Package: `store`
*   `GetAllAlerts(ctx) ([]Alert, error)`
*   `GetPostRecord(ctx, redditID) (*PostRecord, error)`
*   `SavePostRecord(ctx, record *PostRecord) error`
*   `TrimOldPosts(ctx) error`

### Package: `ai`
*   `ParseUserRequest(ctx, userInput) (optimizedQuery string, warning string, error)`
*   `EvaluatePost(ctx, postTitle, postBody, query) (matching bool, summary string, error)`

### Package: `discord`
*   `HandleInteraction(w http.ResponseWriter, r *http.Request)`
*   `SendAlert(channelID, embed) (messageID string, error)`
*   `UpdateMessageStatus(channelID, messageID, status) error`

### Package: `reddit`
*   `FetchNewestPosts() ([]Post, error)`

## External Endpoints

### 1. `GET /cron/scrape`
*   **Trigger**: Invoked by Google Cloud Scheduler every minute.
*   **Action**: Kicks off the `processor.RunPipeline()` function.
*   **Response**: `200 OK` on success, `500 Internal Server Error` on pipeline failure.

### 2. `POST /interactions`
*   **Trigger**: Invoked by Discord when a user executes an Application Command.
*   **Action**: Validates the Ed25519 signature in headers (`X-Signature-Ed25519`, `X-Signature-Timestamp`). Processes the interaction payload.
*   **Response**: JSON payload answering the interaction (e.g., `type: 4` for a channel message with source).
